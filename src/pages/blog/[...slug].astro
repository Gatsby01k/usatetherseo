---
export const prerender = true;

import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
if (!post) throw new Error("Post not found.");

const { Content } = await post.render();

const url = Astro.url;

// Dates
const published =
  post.data.pubDate instanceof Date ? post.data.pubDate : new Date(post.data.pubDate);

const publishedISO = published.toISOString();
const publishedHuman = published.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "2-digit",
});

// Tags
const tags = Array.isArray(post.data.tags) ? post.data.tags : [];

// OG image
const ogImage = new URL(`/og/${post.slug}.png`, url).href;

// JSON-LD (Article + Breadcrumb)
const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: post.data.title,
  description: post.data.description || "",
  datePublished: publishedISO,
  dateModified: publishedISO,
  mainEntityOfPage: url.href,
  author: { "@type": "Organization", name: "usatether.io" },
  publisher: { "@type": "Organization", name: "usatether.io" },
  keywords: tags.join(", "),
};

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: new URL("/", url).href },
    { "@type": "ListItem", position: 2, name: "Blog", item: new URL("/blog/", url).href },
    { "@type": "ListItem", position: 3, name: post.data.title, item: url.href },
  ],
};

// FAQ
const faqItems = Array.isArray(post.data.faq) ? post.data.faq : [];

const faqJsonLd =
  faqItems.length > 0
    ? {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: faqItems.map((it) => ({
          "@type": "Question",
          name: it.q,
          acceptedAnswer: {
            "@type": "Answer",
            text: it.a,
          },
        })),
      }
    : null;
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <!-- SEO: canonical + OG/Twitter + JSON-LD -->
  <head>
    <link rel="canonical" href={url.href} />

    <meta property="og:type" content="article" />
    <meta property="og:url" content={url.href} />
    <meta property="og:title" content={post.data.title} />
    <meta property="og:description" content={post.data.description ?? ""} />
    <meta property="og:image" content={ogImage} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={post.data.title} />
    <meta name="twitter:description" content={post.data.description ?? ""} />
    <meta name="twitter:image" content={ogImage} />

    <script type="application/ld+json" set:html={JSON.stringify(articleJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />

    {faqJsonLd && (
      <script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)} />
    )}
  </head>

  <article class="post">
    <header class="post-header">
      <h1 class="post-title">{post.data.title}</h1>

      <p class="meta">
        <time datetime={publishedISO}>{publishedHuman}</time>

        {tags.length > 0 && (
          <span class="tags">
            {tags.map((t) => (
              <a class="badge" href={`/blog/?tag=${encodeURIComponent(t)}`}>
                {t}
              </a>
            ))}
          </span>
        )}
      </p>

      {post.data.description && <p class="post-lead">{post.data.description}</p>}
    </header>

    <div class="post-body">
      <Content />
    </div>

    {faqItems.length > 0 && (
      <section class="faq">
        <h2>FAQ</h2>

        <div class="faq-list">
          {faqItems.map((it) => (
            <details class="faq-item">
              <summary>{it.q}</summary>
              <p>{it.a}</p>
            </details>
          ))}
        </div>
      </section>
    )}
  </article>
</BaseLayout>
