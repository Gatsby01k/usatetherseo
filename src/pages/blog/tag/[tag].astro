---
export const prerender = true;

import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const allTags = new Set<string>();

  for (const p of posts) {
    const tags = Array.isArray(p.data.tags) ? p.data.tags : [];
    for (const t of tags) allTags.add(t);
  }

  return Array.from(allTags).map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.props;

const posts = (await getCollection("blog"))
  .filter((p) => (Array.isArray(p.data.tags) ? p.data.tags : []).includes(tag))
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
---

<BaseLayout title={`Tag: ${tag}`} description={`Posts tagged “${tag}”`}>
  <h1>Tag: {tag}</h1>

  {posts.length === 0 ? (
    <p class="muted">No posts found.</p>
  ) : (
    posts.map((p) => (
      <div class="card">
        <h2 style="margin:0 0 6px">
          <a href={`/blog/${p.slug}/`}>{p.data.title}</a>
        </h2>
        <p class="meta" style="margin:0">
          <time datetime={p.data.pubDate.toISOString()}>
            {p.data.pubDate.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "2-digit" })}
          </time>
        </p>
        {p.data.description && <p class="muted" style="margin:10px 0 0">{p.data.description}</p>}
      </div>
    ))
  )}
</BaseLayout>
