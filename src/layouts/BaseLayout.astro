---
export const prerender = true;

import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

if (!post) {
  throw new Error("Post not found.");
}

const { Content } = await post.render();

const url = Astro.url;

// Date handling
const published =
  post.data.pubDate instanceof Date
    ? post.data.pubDate
    : new Date(post.data.pubDate);

const publishedISO = published.toISOString();
const publishedHuman = published.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "2-digit",
});

// Tags
const tags = Array.isArray(post.data.tags) ? post.data.tags : [];

// JSON-LD
const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: post.data.title,
  description: post.data.description || "",
  datePublished: publishedISO,
  dateModified: publishedISO,
  mainEntityOfPage: url.href,
  author: { "@type": "Organization", name: "usatether.io" },
  publisher: { "@type": "Organization", name: "usatether.io" },
  keywords: tags.join(", "),
};

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: new URL("/", url).href },
    { "@type": "ListItem", position: 2, name: "Blog", item: new URL("/blog/", url).href },
    { "@type": "ListItem", position: 3, name: post.data.title, item: url.href },
  ],
};

const ogImage = new URL(`/og/${post.slug}.png`, url).href;
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <head>
    <link rel="canonical" href={url.href} />

    <meta property="og:type" content="article" />
    <meta property="og:url" content={url.href} />
    <meta property="og:title" content={post.data.title} />
    <meta property="og:description" content={post.data.description ?? ""} />
    <meta property="og:image" content={ogImage} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={post.data.title} />
    <meta name="twitter:description" content={post.data.description ?? ""} />
    <meta name="twitter:image" content={ogImage} />

    <script type="application/ld+json" set:html={JSON.stringify(articleJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
  </head>

  <article class="post">
    <header class="post-header">
      <h1 class="post-title">{post.data.title}</h1>

      <p class="meta">
        <time datetime={publishedISO}>{publishedHuman}</time>

        {tags.length > 0 && (
          <span class="tags">
            {tags.map((t) => (
              <a class="badge" href={`/blog/?tag=${encodeURIComponent(t)}`}>
                {t}
              </a>
            ))}
          </span>
        )}
      </p>

      {post.data.description && (
        <p class="post-lead">{post.data.description}</p>
      )}
    </header>

    <div class="post-body">
      <Content />
    </div>
  </article>
</BaseLayout>
